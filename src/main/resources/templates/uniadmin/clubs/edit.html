<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Edit Club</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
<div class="container mt-4">
    <h2>Edit Club</h2>

    <div th:if="${errorMessage}" class="alert alert-danger" th:text="${errorMessage}"></div>

    <form th:action="@{/uniadmin/clubs/edit/{id}(id=${clubDTO.id})}" th:object="${clubDTO}" method="post" novalidate>
        <div class="mb-3">
            <label for="name" class="form-label">Club Name *</label>
            <input type="text" id="name" th:field="*{name}" class="form-control" />
            <div class="text-danger" th:if="${#fields.hasErrors('name')}" th:errors="*{name}"></div>
        </div>

        <div class="mb-3">
            <label for="description" class="form-label">Description</label>
            <textarea id="description" th:field="*{description}" class="form-control" rows="4"></textarea>
            <div class="text-danger" th:if="${#fields.hasErrors('description')}" th:errors="*{description}"></div>
        </div>

        <div class="mb-3">
            <label for="universityId" class="form-label">University *</label>
            <select id="universityId" th:field="*{universityId}" class="form-select" onchange="fetchAdmins()">
                <option value="" disabled>Select a University</option>
                <option th:each="uni : ${universities}" 
                        th:value="${uni.id}" 
                        th:text="${uni.name}"
                        th:selected="${uni.id == clubDTO.universityId}"></option>
            </select>
            <div class="text-danger" th:if="${#fields.hasErrors('universityId')}" th:errors="*{universityId}"></div>
        </div>

        <div class="mb-3">
            <label for="adminId" class="form-label">Club Admin *</label>
            <select id="adminId" th:field="*{adminId}" class="form-select">
                <option value="" disabled>Select an Admin</option>
                <option th:each="admin : ${clubAdmins}" 
                        th:value="${admin.id}" 
                        th:text="${admin.firstName + ' ' + admin.lastName}"
                        th:selected="${admin.id == clubDTO.adminId}"></option>
            </select>
            <div class="text-danger" th:if="${#fields.hasErrors('adminId')}" th:errors="*{adminId}"></div>
        </div>

        <div class="mb-3">
            <label for="logoUrl" class="form-label">Logo URL</label>
            <input type="text" id="logoUrl" th:field="*{logoUrl}" class="form-control" />
        </div>

        <div class="mb-3">
            <label for="bannerUrl" class="form-label">Banner URL</label>
            <input type="text" id="bannerUrl" th:field="*{bannerUrl}" class="form-control" />
        </div>

        <button type="submit" class="btn btn-primary">Update Club</button>
        <a href="/uniadmin/clubs" class="btn btn-secondary ms-2">Cancel</a>
    </form>
</div>

<script>
    function fetchAdmins() {
        const uniSelect = document.getElementById('universityId');
        const adminSelect = document.getElementById('adminId');
        const uniId = uniSelect.value;

        if(!uniId) return;

        // Clear current admins
        adminSelect.innerHTML = '<option value="" disabled>Loading admins...</option>';

        fetch('/uniadmin/clubs/api/admins-by-university/' + uniId)
            .then(response => response.json())
            .then(data => {
                let options = '<option value="" disabled selected>Select an Admin</option>';
                data.forEach(admin => {
                    options += `<option value="${admin.id}">${admin.firstName} ${admin.lastName}</option>`;
                });
                adminSelect.innerHTML = options;

                // Try to keep selected admin if still in list
                const selectedAdminId = /*[[${clubDTO.adminId}]]*/ '';
                if(selectedAdminId) {
                    adminSelect.value = selectedAdminId;
                }
            })
            .catch(() => {
                adminSelect.innerHTML = '<option value="" disabled>Error loading admins</option>';
            });
    }

    // Initialize admin dropdown on page load
    window.onload = fetchAdmins;
</script>
</body>
</html>
